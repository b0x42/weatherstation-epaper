name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install build

    - name: Get previous tag
      id: prev_tag
      run: |
        PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
        if [ -z "$PREV_TAG" ]; then
          echo "No previous tag found. This may be the first release."
          echo "prev_tag=" >> "$GITHUB_OUTPUT"
        else
          echo "prev_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"
          echo "Previous tag: $PREV_TAG"
        fi

    - name: Generate changelog
      id: changelog
      run: |
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"

        echo "Generating changelog from $PREV_TAG to $CURRENT_TAG"

        # Get commit log
        if [ -n "$PREV_TAG" ]; then
          COMMITS=$(git log --pretty=format:"- %s" "$PREV_TAG..$CURRENT_TAG")
        else
          COMMITS=$(git log --pretty=format:"- %s" "$CURRENT_TAG")
        fi

        # Extract PR numbers
        PRS=$(echo "$COMMITS" | grep -o '#[0-9]\+' | sort -u | sed 's/#/- #/g')

        # Create changelog file
        {
          echo "## What's Changed"
          echo ""
          echo "$COMMITS"
          echo ""
          echo "## Merged Pull Requests"
          echo "$PRS"
          echo ""
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$CURRENT_TAG"
        } > CHANGELOG.md

        echo "Changelog generated"

    - name: Check if release already exists
      id: check_release
      run: |
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        if gh release view "$CURRENT_TAG" > /dev/null 2>&1; then
          echo "Release $CURRENT_TAG already exists, skipping creation"
          echo "exists=true" >> "$GITHUB_OUTPUT"
        else
          echo "Release $CURRENT_TAG does not exist"
          echo "exists=false" >> "$GITHUB_OUTPUT"
        fi
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Build Python package
      if: steps.check_release.outputs.exists == 'false'
      run: python -m build

    - name: Create GitHub Release
      if: steps.check_release.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        body_path: CHANGELOG.md
        files: |
          dist/*.whl
          dist/*.tar.gz
        draft: false
        prerelease: false
